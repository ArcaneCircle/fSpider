<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width"/>
    <title>Fuzzley - Spider Solitaire</title>
    <link href="content/site.css" rel="stylesheet"/>
    <link href="content/spider.css" rel="stylesheet"/>
</head>
<body>
<div id="canvas-wrap">
</div>
<div id="statistics-container">
    <div style="display:inline-block;">
        <div id="score-wrap" class="modal-wrap">
            <div id="score-display">Score: 0</div>
        </div>
        <div id="moves-wrap" class="modal-wrap">
            <div id="moves-display">Moves: 0</div>
        </div>
        <div id="time-elapsed-wrap" class="modal-wrap">
            <div id="time-elapsed-display">Time: 00:00</div>
        </div>
    </div>
    <div style="display:inline-block;">
        <div class="modal-wrap">
            <button id="new-game-btn">New Game</button>
            <label for="difficulty-select"></label>
            <select id="difficulty-select" name="difficulty-select">
                <option>1 Suit</option>
                <option>2 Suits</option>
                <option>4 Suits</option>
            </select>
            <button id="undo-btn" disabled="disabled">Undo (Ctrl+Z)</button>
            <button id="redo-btn" disabled="disabled">Redo (Ctrl+Y)</button>
        </div>
    </div>
</div>
<div id="canvas-resources">
    <!-- cards -->
    <img id="playing-card-assets-large" src="content/art_assets/cards/playing_card_assets_large.png" />

    <!-- miscellaneous -->
    <img id="tableau-ph" src="content/art_assets/cards/tableau_ph.png"/>
</div>

<script src="scripts/jquery/jquery-2.0.3.min.js"></script>
<script src="scripts/kinetic/kinetic-v4.5.4.min.js"></script>
<script src="scripts/howler/howler.min.js"></script>

<script src="scripts/spider/fSpider.utils.js"></script>
<script src="scripts/spider/fSpider.history.js"></script>
<script src="scripts/spider/fSpider.settings.js"></script>
<script src="scripts/spider/fSpider.card.js"></script>
<script src="scripts/spider/fSpider.card.deck.js"></script>
<script src="scripts/spider/fSpider.card.groups.js"></script>
<script src="scripts/spider/fSpider.board.js"></script>

<script type="text/javascript">
    var fSpider = fSpider || {};
    fSpider.board = {};
    fSpider.deck = {};
    fSpider.stage = {};
    fSpider.ctrlKeyCode = 17;
    fSpider.ctrlDown = false;
    fSpider.undoKey = 'Z';
    fSpider.redoKey = 'Y';

    fSpider.init = function () {
        //setup external ui
        fSpider.initGameControls();

        //prepare stage
        var canvasWrap = $('#canvas-wrap');
        fSpider.stage = new Kinetic.Stage({
            container: 'canvas-wrap',
            width: canvasWrap.width(),
            height: canvasWrap.height()
        });
        var stage = fSpider.stage;

        //prepare assets
        var cardAssetsImg = $('#playing-card-assets-large').get(0);
        var cardDim = {
            width: cardAssetsImg.naturalWidth / 13, // number of types
            height: cardAssetsImg.naturalHeight / 5 // number of suits + back images row
        };
        var tableauPlaceHolderImage = $('#tableau-ph').get(0);

        //prepare board
        fSpider.board = new fSpider.SpiderBoard(stage, cardAssetsImg, cardDim);
        var board = fSpider.board;
        board.recalculateGlobalScale();
        ////set image assets
        board.setCardBackImage(cardAssetsImg, {
            x: 0,
            y: cardDim.height * 4, // the back image is on the last row of the image (after the 4 rows of different suits)
            width: cardDim.width,
            height: cardDim.height
        });
        board.setTableauPlaceHolderImage(tableauPlaceHolderImage);
        ////hook into events
        board.getHistory().onHistoryChanged(fSpider.onHistoryChanged);
        board.onScoreChanged(fSpider.onScoreChanged);
        board.onMovesChanged(fSpider.onMovesChanged);
        board.onTimeElapsedChanged(fSpider.onTimeElapsedTick);

        //in case of resize, notify board
        $(window).resize(function () {
            canvasWrap = $('#canvas-wrap');
            stage.setWidth(canvasWrap.width());
            stage.setHeight(canvasWrap.height());
            board.recalculateGlobalScale();
            board.redraw();
        });

        $(document).on('keydown', function (evt) {
            if (evt.keyCode === fSpider.ctrlKeyCode) {
                fSpider.ctrlDown = true;
            } else if (String.fromCharCode(evt.keyCode) === fSpider.undoKey) {
                if (fSpider.ctrlDown === true) {
                    fSpider.board.undo();
                }
            } else if (String.fromCharCode(evt.keyCode) === fSpider.redoKey) {
                if (fSpider.ctrlDown === true) {
                    fSpider.board.redo();
                }
            }
        });

        $(document).on('keyup', function (evt) {
            if (evt.keyCode === fSpider.ctrlKeyCode) {
                fSpider.ctrlDown = false;
            }
        });
    };

    fSpider.initGameControls = function () {
        $('#new-game-btn').on('click', function () {
            fSpider.startNewGame();
        });
        $('#undo-btn').on('click', function () {
            if ($('#undo-btn').attr('disabled') !== 'disabled') {
                fSpider.board.undo();
            }
        });
        $('#redo-btn').on('click', function () {
            if ($('#redo-btn').attr('disabled') !== 'disabled') {
                fSpider.board.redo();
            }
        });
    };

    fSpider.startNewGame = function () {
        if (fSpider.board.isGameInProgress() !== true || confirm("Are you sure you want to start a new game? Your current game will be replaced.") === true) {
            fSpider.board.startNewGame(fSpider.getDifficulty());
        }
    };

    fSpider.onHistoryChanged = function (history) {
        if (history.canUndo() === true) {
            $('#undo-btn').removeAttr('disabled');
        } else {
            $('#undo-btn').attr('disabled', 'disabled');
        }
        if (history.canRedo() === true) {
            $('#redo-btn').removeAttr('disabled');
        } else {
            $('#redo-btn').attr('disabled', 'disabled');
        }
    };

    fSpider.onScoreChanged = function (score) {
        $('#score-display').text('Score: ' + score);
    };

    fSpider.onMovesChanged = function (moves) {
        $('#moves-display').text('Moves: ' + moves);
    };

    fSpider.onTimeElapsedTick = function (time) {
        $('#time-elapsed-display').text('Time: ' + fSpider.Utils.formatTime(time));
    };

    fSpider.getDifficulty = function () {
        var difficulty = fSpider.SpiderBoard.DIFFICULTIES.OneSuit;

        var selected = $('#difficulty-select').find(':selected').text();
        if (selected === '2 Suits') {
            difficulty = fSpider.SpiderBoard.DIFFICULTIES.TwoSuit;
        } else if (selected === '4 Suits') {
            difficulty = fSpider.SpiderBoard.DIFFICULTIES.FourSuit;
        }

        return difficulty;
    };

    $(window).load(function () {
        fSpider.init();
    });
</script>
</body>
</html>
